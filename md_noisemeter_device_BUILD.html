<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Noisemeter Device: Build Instructions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Noisemeter Device
   &#160;<span id="projectnumber">0.0.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Build Instructions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Source code preparation</h1>
<ol type="1">
<li>Update SSL certificate using the following command: <div class="fragment"><div class="line">python cert.py -s noisemeter.webcomand.com -n webcomand</div>
</div><!-- fragment --> Then copy the console output to certs.h.</li>
<li>Create secret.h file with thre following contents: <div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* API_TOKEN = <span class="stringliteral">&quot;Your API token here&quot;</span>;</div>
</div><!-- fragment --> (Replace "Your API token here" with your API token)</li>
<li>Copy <code><a class="el" href="config_8h_8example_source.html">config.h.example</a></code> to <code>config.h</code> and edit the file to select your board type and set your device ID.</li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
Code compiling and upload</h1>
<h2><a class="anchor" id="autotoc_md3"></a>
PlatformIO</h2>
<ol type="1">
<li><a href="https://platformio.org/install">Install PlatformIO</a>.</li>
<li>Run <code>pio run</code> to compile for the PCB. A breadboard target is available too: <code>pio run -e esp32-breadboard</code>.</li>
<li>Run <code>pio run -t upload</code> to upload to the device (this also compiles the code if there have been any changes).</li>
</ol>
<h2><a class="anchor" id="autotoc_md4"></a>
Arduino</h2>
<ol type="1">
<li>Install the Arduino IDE and <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html">follow these instructions</a> to add support for ESP32 microcontrollers.</li>
<li>Under "Tools" &gt; "Board: " &gt; "ESP32 Arduino", select either "ESP32C3 Dev Module" for the PCB boards or "ESP32-WROOM-DA Module" for the ESP32 breadboard prototype.</li>
<li>Compile the sketch and upload it to the device.</li>
</ol>
<h1><a class="anchor" id="autotoc_md5"></a>
HMAC encryption key</h1>
<p>Data stored on the device (e.g. WiFi credentials) are encrypted with an "eFuse" key. This key can only be written once, and is not be read or written after that.</p>
<p>Using PlatformIO:</p>
<div class="fragment"><div class="line">dd if=/dev/urandom of=hmac_key bs=1 count=32</div>
<div class="line">pio pkg exec -- espefuse.py --port /dev/ttyACM0 burn_key BLOCK4 hmac_key HMAC_UP</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Operating Instructions:</h1>
<ul>
<li>Power on the device by connecting it to power. The device should start in Hotspot mode.</li>
<li>Connect to device's wifi hotspot, which will be called "Noise Meter". Password is "noisemeter".</li>
<li>Open a web browser and navigate to IP address 4.3.2.1 and fill out your Wifi network SSID and password. This will then bbe saved to the onboard flash, and should persist between restarts.</li>
<li>The device should reset and begin attempting to connect to wifi. Use Serial monitor to confirm this.</li>
<li>Once connected, the device will sync itself with a NTP time server and then begin taking readings.</li>
<li>The device fills a buffer with integer readings from the microphone until it has enough to</li>
<li>Periodically (at a time interval determined by UPLOAD_INTERVAL_MS) the device will collate its data and upload it to the server, whereupon it will clear its cached data and begin taking readings again.</li>
<li>To clear your saved information, hold the Reset button (Pin 5 in this example) while you power on the device, or hold the Reset button and reset the device using the built-in reset button. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>

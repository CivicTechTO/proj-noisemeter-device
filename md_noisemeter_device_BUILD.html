<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tRacket Sensor: Build Instructions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tRacket Sensor
   &#160;<span id="projectnumber">0.2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Build Instructions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Source code preparation</h1>
<ol type="1">
<li>Save the SSL root certificate to <code>certs.h</code> using the following command: <div class="fragment"><div class="line">python certs.py -s api.tracket.info &gt; certs.h</div>
</div><!-- fragment --></li>
<li>Copy <code><a class="el" href="config_8h_8example_source.html">config.h.example</a></code> to <code>config.h</code>; if compiling with the Arduino IDE, edit the file to select your board type.</li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
Code compiling and upload</h1>
<h2><a class="anchor" id="autotoc_md3"></a>
PlatformIO</h2>
<ol type="1">
<li><a href="https://platformio.org/install">Install PlatformIO</a>.</li>
<li>Run <code>pio run</code> to compile for the PCB. A breadboard target is available too: <code>pio run -e esp32-breadboard</code>.</li>
<li>Run <code>pio run -t upload</code> to upload to the device (this also compiles the code if there have been any changes).</li>
</ol>
<h2><a class="anchor" id="autotoc_md4"></a>
Arduino</h2>
<ol type="1">
<li>Install the Arduino IDE and <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html">follow these instructions</a> to add support for ESP32 microcontrollers.</li>
<li>Under "Tools" &gt; "Board: " &gt; "ESP32 Arduino", select either "ESP32C3 Dev Module" for the PCB boards or "ESP32-WROOM-DA Module" for the ESP32 breadboard prototype.</li>
<li>Compile the sketch and upload it to the device.</li>
</ol>
<h1><a class="anchor" id="autotoc_md5"></a>
HMAC encryption key</h1>
<p>Data stored on the device (e.g. WiFi credentials) are encrypted with an "eFuse" key. This key can only be written once, and is not be read or written after that.</p>
<p>Using PlatformIO:</p>
<div class="fragment"><div class="line">dd if=/dev/urandom of=hmac_key bs=1 count=32</div>
<div class="line">pio pkg exec -- espefuse.py --port /dev/ttyACM0 burn_key BLOCK4 hmac_key HMAC_UP</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Enable secure download mode</h1>
<p>Enabling secure download mode prevents users from using USB/serial download mode to dump memory contents (WiFi credentials and <a class="el" href="classAPI.html" title="Provides interface for API calls.">API</a> token):</p>
<div class="fragment"><div class="line">pio pkg exec -- espefuse.py --port /dev/ttyACM0 burn_efuse ENABLE_SECURE_DOWNLOAD</div>
</div><!-- fragment --><p>Then, if new firmware is to be uploaded over USB in the future, upload using this command:</p>
<div class="fragment"><div class="line">pio pkg exec -- esptool.py write_flash 0x10000 .pio/build/esp32-pcb/firmware.bin</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7"></a>
Signing OTA updates</h1>
<p>A 4096-bit RSA key is used to sign OTA updates. Whoever controls the private OTA signing key can create a public key with this command and include its contents in <code>noisemeter_device/ota_update.cpp</code>:</p>
<div class="fragment"><div class="line">openssl rsa -in priv_key.pem -pubout &gt; rsa_key.pub</div>
</div><!-- fragment --><p>They may also sign a firmware update with these commands (the signature is prepended to the firmware binary):</p>
<div class="fragment"><div class="line">openssl dgst -sign priv_key.pem -keyform PEM -sha256 -out firmware.sign -binary .pio/build/esp32-pcb/firmware.bin</div>
<div class="line">cat firmware.sign .pio/build/esp32-pcb/firmware.bin &gt; firmware_signed.bin</div>
</div><!-- fragment --><p><code>firmware_signed.bin</code> is then uploaded to the OTA server.</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Operation Overview:</h1>
<ul>
<li>After initial programming or a factory reset, the device will enter Hotspot mode once it is powered on. This is indicated by a blinking LED.</li>
<li>In Hotspot mode, you can connect to the device's "Noise meter" WiFi network to set it up. Password is "noisemeter".</li>
<li>Once connected, a captive portal will bring you to a form to enter your WiFi credentials and email for registration. Your credentials will be encrypted and stored to the on-board flash memory.</li>
<li>After completing the form, the device will reboot and attempt to connect to your WiFi.</li>
<li>Once connected, the device will sync itself with a NTP time server and then begin taking readings.</li>
<li>The device takes 100-millisecond audio recordings and instantly converts them to decibel "loudness" values. Each recording is discarded as soon as it is processed.</li>
<li>Over time, the decibel values are aggregated into minimum, average, and maximum values. Periodically, these values will be uploaded to the server at which point the device will clear its cached data and begin taking a new set of readings.</li>
<li>To factory reset the device and clear your saved credentials, hold the Reset button while you power on the device until the LED begins blinking. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
